<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>MangaNest</title>
<style>
body { font-family: system-ui; margin:0; background:#f4f4f4 }
header { background:#222; color:white; padding:10px; display:flex; gap:6px; flex-wrap:wrap }
header button { border:none; padding:6px 10px; border-radius:4px; cursor:pointer }
header button.active { background:#555 }
section { padding:15px }
.card { background:white; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc }
img.cover { height:100px; margin-right:10px }
.row { display:flex; gap:10px; align-items:center }
label { display:block }
input, select { padding:4px }
.danger { background:#c62828; color:white }
.ok { background:#2e7d32; color:white }
.small { font-size:0.9em; color:#555 }
</style>
</head>
<body>

<header id="menu"></header>
<section id="content"></section>

<script>
const DBKEY = "manganest-db";

let db = JSON.parse(localStorage.getItem(DBKEY)) || {
  currentUser: null,
  users: [
    {id:"simone", name:"Simone", color:"#4CAF50", avatar:""},
    {id:"andrea", name:"Andrea", color:"#FFC107", avatar:""}
  ],
  sagas: [],
  series: [],
  volumes: []
};

function save(){ localStorage.setItem(DBKEY, JSON.stringify(db)); }

const sections = [
  "Home","Utente","Database","Aggiungi numeri",
  "Segna come letto","Lettura","Edicola","Backup"
];

let currentSection="Home";

function renderMenu(){
  const m=document.getElementById("menu");
  m.innerHTML="";
  sections.forEach(s=>{
    const b=document.createElement("button");
    b.textContent=s;
    if(currentSection===s) b.classList.add("active");
    b.onclick=()=>{ currentSection=s; render(); };
    m.appendChild(b);
  });
}

function render(){
  renderMenu();
  const c=document.getElementById("content");
  c.innerHTML="";
  if(!db.currentUser && currentSection!=="Utente") currentSection="Utente";

  ({
    Home:renderHome,
    Utente:renderUser,
    Database:renderDatabase,
    "Aggiungi numeri":renderAddNumbers,
    "Segna come letto":renderMarkRead,
    Lettura:renderReading,
    Edicola:renderEdicola,
    Backup:renderBackup
  })[currentSection](c);
}

/* ---------- HOME ---------- */
function renderHome(c){
  c.innerHTML="<h2>MangaNest</h2><p>Gestione completa manga e letture condivise.</p>";
}

/* ---------- UTENTE ---------- */
function renderUser(c){
  c.innerHTML="<h2>Chi sta usando l'app?</h2>";
  db.users.forEach(u=>{
    const d=document.createElement("div");
    d.className="card row";
    d.innerHTML=`
      <img src="${u.avatar||"https://via.placeholder.com/80"}" width="80">
      <b>${u.name}</b>
      <input type="color" value="${u.color}">
      <input placeholder="Avatar URL" value="${u.avatar}">
      <button class="ok">Usa</button>
    `;
    const [ , , col, av, btn ] = d.children;
    col.onchange=()=>{u.color=col.value; save();};
    av.onchange=()=>{u.avatar=av.value; save();};
    btn.onclick=()=>{db.currentUser=u.id; save(); render();};
    c.appendChild(d);
  });
}

/* ---------- DATABASE ---------- */
function renderDatabase(c){
  c.innerHTML="<h2>Database</h2>";

  const s=document.createElement("div");
  s.className="card";
  s.innerHTML="<h3>Saghe</h3><input id='ns'><button>+</button>";
  s.querySelector("button").onclick=()=>{
    const v=s.querySelector("#ns").value.trim();
    if(v){ db.sagas.push(v); save(); render(); }
  };
  db.sagas.forEach((g,i)=>{
    const p=document.createElement("p");
    p.innerHTML=`${g} <button class="danger">x</button>`;
    p.querySelector("button").onclick=()=>{db.sagas.splice(i,1); save(); render();};
    s.appendChild(p);
  });
  c.appendChild(s);

  const d=document.createElement("div");
  d.className="card";
  d.innerHTML=`
    <h3>Nuova serie</h3>
    <input id="n" placeholder="Nome">
    <select id="sg"><option value="">Nessuna saga</option>${db.sagas.map(x=>`<option>${x}</option>`)}</select>
    <select id="st"><option>in corso</option><option>finita</option><option>interrotta</option></select>
    <input id="au" placeholder="Autori (,)">
    <input id="ed" placeholder="Editore">
    <input id="im" placeholder="URL immagine">
    <button>Aggiungi</button>
  `;
  d.querySelector("button").onclick=()=>{
    db.series.push({
      id:crypto.randomUUID(),
      name:d.querySelector("#n").value,
      saga:d.querySelector("#sg").value,
      status:d.querySelector("#st").value,
      authors:d.querySelector("#au").value.split(",").map(x=>x.trim()),
      publisher:d.querySelector("#ed").value,
      img:d.querySelector("#im").value
    });
    save(); render();
  };
  c.appendChild(d);

  db.series.forEach(sr=>{
    const p=document.createElement("div");
    p.className="card";
    p.innerHTML=`<b>${sr.name}</b> (${sr.status}) <button class="danger">x</button>`;
    p.querySelector("button").onclick=()=>{
      db.volumes=db.volumes.filter(v=>v.series!==sr.id);
      db.series=db.series.filter(x=>x.id!==sr.id);
      save(); render();
    };
    c.appendChild(p);
  });
}

/* ---------- AGGIUNGI NUMERI ---------- */
function renderAddNumbers(c){
  c.innerHTML="<h2>Aggiungi numeri</h2>";
  if(!db.series.length){c.innerHTML+="<p>Nessuna serie</p>";return;}
  const d=document.createElement("div");
  d.className="card";
  d.innerHTML=`
    <select id="s">${db.series.map(x=>`<option value="${x.id}">${x.name}</option>`)}</select>
    <input id="n" placeholder="Numero o intervallo (es 1-5)">
    <button>Aggiungi</button>
  `;
  d.querySelector("button").onclick=()=>{
    const sid=d.querySelector("#s").value;
    const val=d.querySelector("#n").value;
    let nums=[];
    if(val.includes("-")){
      let [a,b]=val.split("-").map(Number);
      for(let i=a;i<=b;i++) nums.push(i);
    } else nums=[Number(val)];
    nums.forEach(n=>{
      db.volumes.push({id:crypto.randomUUID(),series:sid,number:n,read:{}});
    });
    save(); render();
  };
  c.appendChild(d);
}

/* ---------- SEGNA COME LETTO ---------- */
function renderMarkRead(c){
  c.innerHTML="<h2>Segna come letto</h2>";
  const u=db.currentUser;
  const sel=document.createElement("select");
  db.series.forEach(s=>sel.innerHTML+=`<option value="${s.id}">${s.name}</option>`);
  c.appendChild(sel);
  const list=document.createElement("div"); c.appendChild(list);

  function draw(){
    list.innerHTML="";
    db.volumes.filter(v=>v.series===sel.value).forEach(v=>{
      const l=document.createElement("label");
      const cb=document.createElement("input"); cb.type="checkbox";
      cb.checked=v.read[u]||false;
      cb.onchange=()=>{v.read[u]=cb.checked; save();};
      l.append(cb," Volume "+v.number);
      list.appendChild(l);
    });
  }
  sel.onchange=draw; draw();
}

/* ---------- LETTURA ---------- */
function renderReading(c){
  c.innerHTML="<h2>Lettura</h2>";
  const u=db.currentUser;
  db.series.forEach(s=>{
    const d=document.createElement("div"); d.className="card";
    d.innerHTML=`<b>${s.name}</b>`;
    db.volumes.filter(v=>v.series===s.id).forEach(v=>{
      const l=document.createElement("label");
      const cb=document.createElement("input"); cb.type="checkbox";
      cb.checked=v.read[u]||false;
      cb.onchange=()=>{v.read[u]=cb.checked; save();};
      l.append(cb," Vol."+v.number);
      d.appendChild(l);
    });
    c.appendChild(d);
  });
}

/* ---------- EDICOLA (AGGIORNATA) ---------- */
function renderEdicola(c){
  c.innerHTML="<h2>Edicola</h2>";
  const u=db.currentUser;

  db.series
    .filter(s=>s.status==="in corso")
    .forEach(s=>{
      const vols=db.volumes.filter(v=>v.series===s.id);
      if(!vols.length) return;

      const owned=vols.map(v=>v.number).sort((a,b)=>a-b);
      const lastOwned=Math.max(...owned);
      const missing=vols.filter(v=>!v.read[u]).map(v=>v.number);

      if(!missing.length) return;

      const d=document.createElement("div");
      d.className="card";
      d.innerHTML=`
        <b>${s.name}</b><br>
        <span class="small">Ultimo volume che possiedi: <b>${lastOwned}</b></span><br>
        <span class="small">Volumi mancanti: ${missing.join(", ")}</span>
      `;
      c.appendChild(d);
    });
}

/* ---------- BACKUP ---------- */
function renderBackup(c){
  const b=document.createElement("button");
  b.textContent="Scarica CSV";
  b.onclick=()=>{
    let csv="Serie,Volume,Letto da\n";
    db.volumes.forEach(v=>{
      csv+=`${db.series.find(s=>s.id===v.series).name},${v.number},${Object.keys(v.read).filter(x=>v.read[x]).join("|")}\n`;
    });
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv]));
    a.download="manganest.csv"; a.click();
  };
  c.appendChild(b);
}

render();
</script>
</body>
</html>
